---
interface Props {
    title: string;
    description?: string;
    kicker?: string;
    variant?: 'white' | 'black' | 'blue' | 'peach' | 'lavender';
    class?: string;
    span?: number;
}

const { 
    title, 
    description, 
    kicker, 
    variant = 'white', 
    class: className = '',
    span = 4
} = Astro.props;

const bgClasses = {
    white: 'card-bg-white',
    black: 'card-bg-black',
    blue: 'card-bg-blue',
    peach: 'card-bg-peach',
    lavender: 'card-bg-lavender',
};
---

<div class={`card card-animate ${bgClasses[variant]} ${className}`} style={`grid-column: span ${span};`}>
    <div class="card-content">
        {kicker && <div class="card-kicker">{kicker}</div>}
        <h2 class="card-title">{title}</h2>
        {description && <p class="card-desc">{description}</p>}
        <slot />
    </div>
    <slot name="footer" />
</div>

<script>
    // Intersection Observer for card fade-in animations
    function initCardAnimations() {
        // Respect prefers-reduced-motion
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        if (prefersReducedMotion) {
            // If user prefers reduced motion, show all cards immediately
            document.querySelectorAll('.card-animate').forEach(card => {
                (card as HTMLElement).style.opacity = '1';
                (card as HTMLElement).style.transform = 'translateY(0)';
            });
            return;
        }

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('card-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        });

        document.querySelectorAll('.card-animate').forEach(card => {
            observer.observe(card);
        });
    }

    // Run on initial load
    initCardAnimations();

    // Re-run on Astro page transitions
    document.addEventListener('astro:page-load', initCardAnimations);
</script>

<style>
    .card {
        border-radius: var(--radius-lg);
        padding: 40px;
        position: relative;
        overflow: hidden;
        transition: transform var(--trans-speed) var(--ease-smooth),
                    box-shadow var(--trans-speed) var(--ease-smooth),
                    opacity 0.6s var(--ease-smooth);
        cursor: default;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 240px;
    }

    /* Fade-in animation states */
    .card-animate {
        opacity: 0;
        transform: translateY(20px);
    }

    .card-visible {
        opacity: 1;
        transform: translateY(0);
    }

    /* Respect reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
        .card-animate {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card:hover {
        transform: translateY(-4px) scale(1.005);
        box-shadow: 0 20px 40px var(--c-shadow);
    }

    .card-bg-white {
        background-color: var(--c-surface);
        color: var(--c-text-primary);
    }

    .card-bg-black {
        background-color: var(--c-primary);
        color: var(--c-primary-inverse);
    }

    .card-bg-blue {
        background-color: var(--c-blue);
        color: var(--c-card-text-dark);
    }

    .card-bg-peach {
        background-color: var(--c-peach);
        color: var(--c-card-text-dark);
    }

    .card-bg-lavender {
        background-color: var(--c-lavender);
        color: var(--c-card-text-dark);
    }

    /* Dark mode: Use darker backgrounds with improved contrast (WCAG AAA 5.5:1) */
    :global([data-theme="dark"]) .card-bg-blue {
        background-color: #0f2a38;
        color: var(--c-blue);
    }

    :global([data-theme="dark"]) .card-bg-peach {
        background-color: #3d2815;
        color: var(--c-peach);
    }

    :global([data-theme="dark"]) .card-bg-lavender {
        background-color: #1f1830;
        color: var(--c-lavender);
    }

    .card-kicker {
        font-family: var(--font-body);
        font-size: var(--text-xs);
        font-weight: var(--weight-semibold);
        text-transform: uppercase;
        letter-spacing: var(--tracking-wide);
        opacity: 0.7;
        margin-bottom: 16px;
    }

    .card-title {
        font-family: var(--font-display);
        font-size: var(--text-3xl);
        font-weight: var(--weight-bold);
        line-height: var(--leading-tight);
        letter-spacing: var(--tracking-tight);
    }

    .card-bg-black .card-title {
        color: var(--c-primary-inverse);
    }

    :global([data-theme="dark"]) .card-bg-white .card-title {
        color: var(--c-text-primary);
    }

    .card-desc {
        font-family: var(--font-body);
        margin-top: 16px;
        font-size: var(--text-lg);
        opacity: 0.8;
        line-height: var(--leading-relaxed);
    }

    @media (max-width: 1024px) {
        .card {
            grid-column: span 1 !important;
            padding: 30px;
        }
    }

    @media (max-width: 640px) {
        .card {
            padding: 24px;
            min-height: 200px;
        }

        .card-kicker {
            margin-bottom: 12px;
        }

        .card-desc {
            margin-top: 12px;
        }
    }

    @media (max-width: 480px) {
        .card {
            padding: 20px;
        }
    }
</style>
